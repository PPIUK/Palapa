{"version":3,"sources":["useCarouselController.tsx"],"names":["useCarouselController","options","size","loop","handlerOffsetX","withAnimation","disable","originalLength","length","onChange","duration","defaultIndex","index","sharedIndex","React","useRef","sharedPreIndex","currentFixedPage","useCallback","Math","round","value","fixed","abs","convertToSharedIndex","i","computedIndex","current","toInt","_sharedIndex","getCurrentIndex","canSliding","onScrollEnd","onScrollBegin","scrollWithTiming","toValue","onFinished","callback","isFinished","runOnJS","defaultWithAnimation","type","config","easing","Easing","easeOutQuart","dealWithAnimation","next","opts","count","animated","nextPage","prev","prevPage","to","idx","offset","scrollTo","n"],"mappings":"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","sourcesContent":["import React from 'react';\nimport type Animated from 'react-native-reanimated';\nimport { Easing } from '../constants';\nimport { runOnJS, useSharedValue } from 'react-native-reanimated';\nimport type {\n    TCarouselActionOptions,\n    TCarouselProps,\n    WithTimingAnimation,\n} from '../types';\nimport { dealWithAnimation } from '@/utils/dealWithAnimation';\n\ninterface IOpts {\n    loop: boolean;\n    size: number;\n    handlerOffsetX: Animated.SharedValue<number>;\n    withAnimation?: TCarouselProps['withAnimation'];\n    disable?: boolean;\n    duration?: number;\n    originalLength: number;\n    length: number;\n    defaultIndex?: number;\n    onScrollBegin?: () => void;\n    onScrollEnd?: () => void;\n    // the length before fill data\n    onChange: (index: number) => void;\n}\n\nexport interface ICarouselController {\n    length: number;\n    index: Animated.SharedValue<number>;\n    sharedIndex: React.MutableRefObject<number>;\n    sharedPreIndex: React.MutableRefObject<number>;\n    prev: (opts?: TCarouselActionOptions) => void;\n    next: (opts?: TCarouselActionOptions) => void;\n    computedIndex: () => void;\n    getCurrentIndex: () => number;\n    to: (index: number, animated?: boolean) => void;\n    scrollTo: (opts?: TCarouselActionOptions) => void;\n}\n\nexport function useCarouselController(options: IOpts): ICarouselController {\n    const {\n        size,\n        loop,\n        handlerOffsetX,\n        withAnimation,\n        disable = false,\n        originalLength,\n        length,\n        onChange,\n        duration,\n        defaultIndex = 0,\n    } = options;\n\n    const index = useSharedValue<number>(defaultIndex);\n    // The Index displayed to the user\n    const sharedIndex = React.useRef<number>(defaultIndex);\n    const sharedPreIndex = React.useRef<number>(defaultIndex);\n\n    const currentFixedPage = React.useCallback(() => {\n        if (loop) {\n            return -Math.round(handlerOffsetX.value / size);\n        }\n\n        const fixed = (handlerOffsetX.value / size) % length;\n        return Math.round(\n            handlerOffsetX.value <= 0\n                ? Math.abs(fixed)\n                : Math.abs(fixed > 0 ? length - fixed : 0)\n        );\n    }, [handlerOffsetX, length, size, loop]);\n\n    const convertToSharedIndex = React.useCallback(\n        (i: number) => {\n            if (loop) {\n                switch (originalLength) {\n                    case 1:\n                        return 0;\n                    case 2:\n                        return i % 2;\n                }\n            }\n            return i;\n        },\n        [originalLength, loop]\n    );\n\n    const computedIndex = React.useCallback(() => {\n        sharedPreIndex.current = sharedIndex.current;\n        const toInt = (handlerOffsetX.value / size) % length;\n        const i =\n            handlerOffsetX.value <= 0\n                ? Math.abs(toInt)\n                : Math.abs(toInt > 0 ? length - toInt : 0);\n        index.value = i;\n        const _sharedIndex = convertToSharedIndex(i);\n        sharedIndex.current = _sharedIndex;\n        onChange(_sharedIndex);\n    }, [\n        length,\n        handlerOffsetX,\n        sharedPreIndex,\n        index,\n        size,\n        sharedIndex,\n        convertToSharedIndex,\n        onChange,\n    ]);\n\n    const getCurrentIndex = React.useCallback(() => {\n        return index.value;\n    }, [index]);\n\n    const canSliding = React.useCallback(() => {\n        return !disable;\n    }, [disable]);\n\n    const onScrollEnd = React.useCallback(() => {\n        options.onScrollEnd?.();\n    }, [options]);\n\n    const onScrollBegin = React.useCallback(() => {\n        options.onScrollBegin?.();\n    }, [options]);\n\n    const scrollWithTiming = React.useCallback(\n        (toValue: number, onFinished?: () => void) => {\n            'worklet';\n            const callback = (isFinished: boolean) => {\n                'worklet';\n                if (isFinished) {\n                    runOnJS(onScrollEnd)();\n                    onFinished && runOnJS(onFinished)();\n                }\n            };\n\n            const defaultWithAnimation: WithTimingAnimation = {\n                type: 'timing',\n                config: { duration, easing: Easing.easeOutQuart },\n            };\n\n            return dealWithAnimation(withAnimation ?? defaultWithAnimation)(\n                toValue,\n                callback\n            );\n        },\n        [duration, withAnimation, onScrollEnd]\n    );\n\n    const next = React.useCallback(\n        (opts: TCarouselActionOptions = {}) => {\n            'worklet';\n            const { count = 1, animated = true, onFinished } = opts;\n            if (!canSliding() || (!loop && index.value >= length - 1)) return;\n\n            onScrollBegin?.();\n\n            const nextPage = currentFixedPage() + count;\n            index.value = nextPage;\n\n            if (animated) {\n                handlerOffsetX.value = scrollWithTiming(\n                    -nextPage * size,\n                    onFinished\n                ) as any;\n            } else {\n                handlerOffsetX.value = -nextPage * size;\n                onFinished?.();\n            }\n        },\n        [\n            canSliding,\n            loop,\n            index,\n            length,\n            onScrollBegin,\n            handlerOffsetX,\n            size,\n            scrollWithTiming,\n            currentFixedPage,\n        ]\n    );\n\n    const prev = React.useCallback(\n        (opts: TCarouselActionOptions = {}) => {\n            const { count = 1, animated = true, onFinished } = opts;\n            if (!canSliding() || (!loop && index.value <= 0)) return;\n\n            onScrollBegin?.();\n\n            const prevPage = currentFixedPage() - count;\n            index.value = prevPage;\n\n            if (animated) {\n                handlerOffsetX.value = scrollWithTiming(\n                    -prevPage * size,\n                    onFinished\n                );\n            } else {\n                handlerOffsetX.value = -prevPage * size;\n                onFinished?.();\n            }\n        },\n        [\n            canSliding,\n            loop,\n            index,\n            onScrollBegin,\n            handlerOffsetX,\n            size,\n            scrollWithTiming,\n            currentFixedPage,\n        ]\n    );\n\n    const to = React.useCallback(\n        (idx: number, animated: boolean = false) => {\n            if (idx === index.value) return;\n            if (!canSliding()) return;\n\n            onScrollBegin?.();\n\n            const offset = handlerOffsetX.value + (index.value - idx) * size;\n\n            if (animated) {\n                index.value = idx;\n                handlerOffsetX.value = scrollWithTiming(offset);\n            } else {\n                handlerOffsetX.value = offset;\n                index.value = idx;\n                runOnJS(onScrollEnd)();\n            }\n        },\n        [\n            index,\n            canSliding,\n            onScrollBegin,\n            handlerOffsetX,\n            size,\n            scrollWithTiming,\n            onScrollEnd,\n        ]\n    );\n\n    const scrollTo = React.useCallback(\n        (opts: TCarouselActionOptions = {}) => {\n            const { count, animated = false, onFinished } = opts;\n            if (!count) {\n                return;\n            }\n            const n = Math.round(count);\n            if (n < 0) {\n                prev({ count: Math.abs(n), animated, onFinished });\n            } else {\n                next({ count: n, animated, onFinished });\n            }\n        },\n        [prev, next]\n    );\n\n    return {\n        next,\n        prev,\n        to,\n        scrollTo,\n        index,\n        length,\n        sharedIndex,\n        sharedPreIndex,\n        computedIndex,\n        getCurrentIndex,\n    };\n}\n"]}